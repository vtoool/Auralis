# Developer Guide: Auralis Wellness Platform

This guide provides instructions on how to set up the backend, integrate payments, and deploy the Auralis wellness platform application.

## Table of Contents
1.  [Backend Setup with Supabase](#1-backend-setup-with-supabase)
2.  [Application Structure & Routing](#2-application-structure--routing)
3.  [Owner Dashboard & Management](#3-owner-dashboard--management)
4.  [Payment Integration with Paddle](#4-payment-integration-with-paddle)
5.  [Deployment](#5-deployment)

---

## 1. Backend Setup with Supabase

> **MANDATORY FIRST STEP:** This section is required for the application to function. The app will fail with a "table not found" or "schema cache" error if the database script in Step 2 is not run successfully in your Supabase project.

Supabase is an open-source Firebase alternative providing a PostgreSQL database, authentication, file storage, and serverless functions.

### Step 1: Create a Supabase Project

1.  Go to [supabase.com](https://supabase.com) and sign up/log in.
2.  Create a new project. Choose a strong database password and save it securely.

### Step 2: Run the Database Setup Script

Navigate to the **SQL Editor** in your Supabase dashboard. Click "+ New query" and paste the entire script below. This will create your `courses`, `appointments`, `unavailabilities`, and `contacts` tables, add sample course data, and set up a database function for rescheduling.

**CRITICAL:** After pasting the script, click **"Run"**. You must see a "Success. No rows returned" message. This script is "idempotent," meaning you can safely run it multiple times without causing errors.

```sql
-- 1. Create the 'courses' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.courses (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  type TEXT,
  price NUMERIC,
  "imageUrl" TEXT,
  duration TEXT,
  paddle_product_id TEXT,
  file_url TEXT -- To store the link to the course video/audio file
);

-- Note: RLS is disabled by default for new tables. This command ensures it's off.
-- You should enable and configure RLS policies before going to production.
ALTER TABLE public.courses DISABLE ROW LEVEL SECURITY;

-- 2. Insert mock data to populate the courses section
-- NOTE: If you run this script multiple times, it will insert duplicate mock courses.
-- This is safe for setup but you can delete duplicates from the Supabase table editor.
INSERT INTO public.courses (title, description, type, price, "imageUrl", duration, paddle_product_id)
VALUES
  ('Foundations of Mindfulness', 'A comprehensive video series teaching the core principles of mindfulness to reduce stress and cultivate presence.', 'Video Course', 49.99, 'https://picsum.photos/400/300?random=10', '4 Hours', 'prod_12345'),
  ('Morning Gratitude Meditation', 'Begin each day with a positive and grateful mindset through this beautifully guided audio meditation.', 'Audio Meditation', 9.99, 'https://picsum.photos/400/300?random=11', '15 Mins', 'prod_12346'),
  ('Chakra Balancing for Beginners', 'An introductory video course to understanding, clearing, and balancing your seven chakras for spiritual well-being.', 'Video Course', 69.99, 'https://picsum.photos/400/300?random=12', '6 Hours', 'prod_12347'),
  ('Deep Sleep Hypnosis', 'A soothing audio journey designed to help you release the day and drift into a deep, restorative, and peaceful sleep.', 'Audio Meditation', 14.99, 'https://picsum.photos/400/300?random=13', '30 Mins', 'prod_12348');

-- 3. Create the 'appointments' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.appointments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  date DATE NOT NULL,
  time TEXT NOT NULL,
  service TEXT -- To store the selected service for the appointment
);

-- This ensures the 'service' column exists for new appointment features.
-- It's safe to run even if the column already exists.
ALTER TABLE public.appointments ADD COLUMN IF NOT EXISTS service TEXT;


ALTER TABLE public.appointments DISABLE ROW LEVEL SECURITY;

-- 4. Create the 'unavailabilities' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.unavailabilities (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  unavailable_date DATE NOT NULL,
  start_time TIME, -- Can be null if the whole day is blocked
  end_time TIME,   -- Can be null if the whole day is blocked
  reason TEXT      -- Optional reason, e.g., "Holiday"
);

ALTER TABLE public.unavailabilities DISABLE ROW LEVEL SECURITY;

-- 5. Create the 'contacts' table (for contact form submissions) if it doesn't exist
CREATE TABLE IF NOT EXISTS public.contacts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  message TEXT,
  is_read BOOLEAN DEFAULT FALSE NOT NULL
);

ALTER TABLE public.contacts DISABLE ROW LEVEL SECURITY;

-- 6. Create the server-side function to handle rescheduling appointments atomically
CREATE OR REPLACE FUNCTION reschedule_appointment(
    p_appointment_id BIGINT,
    p_new_date DATE,
    p_new_time TEXT
)
RETURNS void AS $$
DECLARE
    v_old_date DATE;
    v_old_time TEXT;
    v_name TEXT;
    v_new_end_time TIME;
BEGIN
    -- Step 1: Get the old appointment details to find the matching unavailability
    SELECT date, time, name
    INTO v_old_date, v_old_time, v_name
    FROM public.appointments
    WHERE id = p_appointment_id;

    -- Step 2: Delete the old unavailability block to free up the slot
    DELETE FROM public.unavailabilities
    WHERE unavailable_date = v_old_date
      AND start_time = (v_old_time || ':00')::TIME
      AND reason = (v_name || '''s appointment');

    -- Step 3: Update the appointment with the new date and time
    UPDATE public.appointments
    SET date = p_new_date,
        time = p_new_time
    WHERE id = p_appointment_id;

    -- Step 4: Create a new unavailability block for the new time
    -- Calculate end time (30 mins after start)
    v_new_end_time := (p_new_time || ':00')::TIME + interval '30 minutes';

    INSERT INTO public.unavailabilities (unavailable_date, start_time, end_time, reason)
    VALUES (p_new_date, (p_new_time || ':00')::TIME, v_new_end_time, (v_name || '''s appointment'));

END;
$$ LANGUAGE plpgsql;
```

### Step 2a: Create Storage Bucket & Policies

For the course file uploads in the admin dashboard to work, you must create a storage bucket and set its access policies.

1.  **Create the Bucket:**
    *   In your Supabase dashboard, go to **Storage** (the cylinder icon on the left).
    *   Click **"Create a new bucket"**.
    *   Name the bucket exactly `courses`.
    *   Toggle **"Public bucket"** to ON. This allows anyone with the direct URL to view the files.
    *   Click **"Create bucket"**.

2.  **Add Security Policies for Uploads:**
    *   By default, storage buckets are protected from uploads. We need to add rules (called Policies) to allow your admin user (any logged-in user) to upload files.
    *   Go back to the **SQL Editor**.
    *   Click **"+ New query"** and paste and run the following script. This script is safe to run multiple times; it will clean up old policies and apply the new, correct ones.

    > **Troubleshooting Tip:** If you see the error `Upload failed: new row violates row-level security policy`, it means this script was not run successfully. Running this script is the solution.

    ```sql
    -- This script is idempotent and can be run multiple times.
    -- It removes old policies before creating the new, more specific ones.

    -- Drop the old single policy if it exists from a previous version of this guide
    DROP POLICY IF EXISTS "Authenticated users can manage course files" ON storage.objects;

    -- Drop the new policies if they exist, to ensure a clean slate on re-run
    DROP POLICY IF EXISTS "Authenticated users can view course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can upload course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can update course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can delete course files" ON storage.objects;

    -- Create new, specific policies for clarity and correctness:

    -- 1. Policy to allow authenticated users to VIEW/DOWNLOAD files.
    CREATE POLICY "Authenticated users can view course files"
    ON storage.objects FOR SELECT
    TO authenticated
    USING ( bucket_id = 'courses' );

    -- 2. Policy to allow authenticated users to UPLOAD files.
    -- This policy is the specific fix for the "violates row-level security" error on upload.
    CREATE POLICY "Authenticated users can upload course files"
    ON storage.objects FOR INSERT
    TO authenticated
    WITH CHECK ( bucket_id = 'courses' );

    -- 3. Policy to allow authenticated users to UPDATE files (e.g., move/rename).
    CREATE POLICY "Authenticated users can update course files"
    ON storage.objects FOR UPDATE
    TO authenticated
    USING ( bucket_id = 'courses' );

    -- 4. Policy to allow authenticated users to DELETE files.
    CREATE POLICY "Authenticated users can delete course files"
    ON storage.objects FOR DELETE
    TO authenticated
    USING ( bucket_id = 'courses' );
    ```
    *   Click **"Run"**. You must see a "Success. No rows returned" message. Once this is done, your file uploads will work.

### Step 3: Connect Frontend to Supabase

Your Supabase credentials are required to connect the application to the database. They are located in the `src/services/supabaseClient.ts` file.

1.  Open the file `src/services/supabaseClient.ts`.
2.  You will find your credentials already set up for you. If you ever need to change them, this is the file to edit.

    ```typescript
    // src/services/supabaseClient.ts

    const supabaseUrl = "https://qzlxlxowkwtxpdxfdrql.supabase.co";
    const supabaseAnonKey = "eyJhbGciOi...JbJ2Tk"; // Your key
    ```

> **Security Warning:** Hardcoding keys in your frontend code is convenient for initial setup but is not recommended for production. Anyone who can view your website's source code can see these keys. For deployment, you should switch to using **Environment Variables** as described by your hosting provider (e.g., Vercel, Netlify). This involves removing the hardcoded keys and loading them from a secure store, for example: `const supabaseUrl = process.env.VITE_SUPABASE_URL;`

### Troubleshooting Common Errors
> **ATTENTION: READ THIS IF YOU SEE AN ERROR**
> 
> **Common Error Message:**
> > `Could not find the 'file_url' column of 'courses' in the schema cache`
> 
> This is one of the most common setup errors. It means your application is trying to access a column that doesn't exist in your database, or that your browser has an outdated "memory" of your database structure.
> 
> **Solution Steps:**
> 
> 1.  **Surgical Fix (Recommended First Step):** If you have already set up your tables and data but are specifically missing the `file_url`