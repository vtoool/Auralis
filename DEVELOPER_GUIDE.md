# Developer Guide: Auralis Wellness Platform

This guide provides instructions on how to set up the backend, integrate payments, and deploy the Auralis wellness platform application.

## Table of Contents
1.  [Backend Setup with Supabase](#1-backend-setup-with-supabase)
2.  [Email Notifications with Resend](#2-email-notifications-with-resend)
3.  [Backend Logic with Supabase Edge Functions](#3-backend-logic-with-supabase-edge-functions)
4.  [Automating Emails with Database Webhooks](#4-automating-emails-with-database-webhooks)
5.  [Owner Dashboard & Management](#5-owner-dashboard--management)
6.  [Payment Integration with Paddle](#6-payment-integration-with-paddle)
7.  [Deployment](#7-deployment)

---

## 1. Backend Setup with Supabase

> **MANDATORY FIRST STEP:** This section is required for the application to function. The app will fail with a "table not found" or "schema cache" error if the database script in Step 2 is not run successfully in your Supabase project.

Supabase is an open-source Firebase alternative providing a PostgreSQL database, authentication, file storage, and serverless functions.

### Step 1: Create a Supabase Project

1.  Go to [supabase.com](https://supabase.com) and sign up/log in.
2.  Create a new project. Choose a strong database password and save it securely.

### Step 2: Run the Database Setup Script

Navigate to the **SQL Editor** in your Supabase dashboard. Click "+ New query" and paste the entire script below. This will create your `courses`, `appointments`, `unavailabilities`, and `contacts` tables, and add sample course data.

**CRITICAL:** After pasting the script, click **"Run"**. You must see a "Success. No rows returned" message. This script is "idempotent," meaning you can safely run it multiple times without causing errors.

```sql
-- 1. Create the 'courses' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.courses (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  type TEXT,
  price NUMERIC,
  "imageUrl" TEXT,
  duration TEXT,
  paddle_product_id TEXT,
  file_url TEXT -- To store the link to the course video/audio file
);

-- Note: RLS is disabled by default for new tables. This command ensures it's off.
-- You should enable and configure RLS policies before going to production.
ALTER TABLE public.courses DISABLE ROW LEVEL SECURITY;

-- 2. Insert mock data to populate the courses section
-- NOTE: If you run this script multiple times, it will insert duplicate mock courses.
-- This is safe for setup but you can delete duplicates from the Supabase table editor.
INSERT INTO public.courses (title, description, type, price, "imageUrl", duration, paddle_product_id)
VALUES
  ('Foundations of Mindfulness', 'A comprehensive video series teaching the core principles of mindfulness to reduce stress and cultivate presence.', 'Video Course', 49.99, 'https://picsum.photos/400/300?random=10', '4 Hours', 'prod_12345'),
  ('Morning Gratitude Meditation', 'Begin each day with a positive and grateful mindset through this beautifully guided audio meditation.', 'Audio Meditation', 9.99, 'https://picsum.photos/400/300?random=11', '15 Mins', 'prod_12346'),
  ('Chakra Balancing for Beginners', 'An introductory video course to understanding, clearing, and balancing your seven chakras for spiritual well-being.', 'Video Course', 69.99, 'https://picsum.photos/400/300?random=12', '6 Hours', 'prod_12347'),
  ('Deep Sleep Hypnosis', 'A soothing audio journey designed to help you release the day and drift into a deep, restorative, and peaceful sleep.', 'Audio Meditation', 14.99, 'https://picsum.photos/400/300?random=13', '30 Mins', 'prod_12348');

-- 3. Create the 'appointments' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.appointments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  date DATE NOT NULL,
  time TEXT NOT NULL
);

ALTER TABLE public.appointments DISABLE ROW LEVEL SECURITY;

-- 4. Create the 'unavailabilities' table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.unavailabilities (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  unavailable_date DATE NOT NULL,
  start_time TIME, -- Can be null if the whole day is blocked
  end_time TIME,   -- Can be null if the whole day is blocked
  reason TEXT      -- Optional reason, e.g., "Holiday"
);

ALTER TABLE public.unavailabilities DISABLE ROW LEVEL SECURITY;

-- 5. Create the 'contacts' table (for contact form submissions) if it doesn't exist
CREATE TABLE IF NOT EXISTS public.contacts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  message TEXT,
  is_read BOOLEAN DEFAULT FALSE NOT NULL
);

ALTER TABLE public.contacts DISABLE ROW LEVEL SECURITY;
```

### Step 2a: Create Storage Bucket & Policies

For the course file uploads in the admin dashboard to work, you must create a storage bucket and set its access policies.

1.  **Create the Bucket:**
    *   In your Supabase dashboard, go to **Storage** (the cylinder icon on the left).
    *   Click **"Create a new bucket"**.
    *   Name the bucket exactly `courses`.
    *   Toggle **"Public bucket"** to ON. This allows anyone with the direct URL to view the files.
    *   Click **"Create bucket"**.

2.  **Add Security Policies for Uploads:**
    *   By default, storage buckets are protected from uploads. We need to add rules (called Policies) to allow your admin user (any logged-in user) to upload files.
    *   Go back to the **SQL Editor**.
    *   Click **"+ New query"** and paste and run the following script. This script is safe to run multiple times; it will clean up old policies and apply the new, correct ones.

    > **Troubleshooting Tip:** If you see the error `Upload failed: new row violates row-level security policy`, it means this script was not run successfully. Running this script is the solution.

    ```sql
    -- This script is idempotent and can be run multiple times.
    -- It removes old policies before creating the new, more specific ones.

    -- Drop the old single policy if it exists from a previous version of this guide
    DROP POLICY IF EXISTS "Authenticated users can manage course files" ON storage.objects;

    -- Drop the new policies if they exist, to ensure a clean slate on re-run
    DROP POLICY IF EXISTS "Authenticated users can view course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can upload course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can update course files" ON storage.objects;
    DROP POLICY IF EXISTS "Authenticated users can delete course files" ON storage.objects;

    -- Create new, specific policies for clarity and correctness:

    -- 1. Policy to allow authenticated users to VIEW/DOWNLOAD files.
    CREATE POLICY "Authenticated users can view course files"
    ON storage.objects FOR SELECT
    TO authenticated
    USING ( bucket_id = 'courses' );

    -- 2. Policy to allow authenticated users to UPLOAD files.
    -- This policy is the specific fix for the "violates row-level security" error on upload.
    CREATE POLICY "Authenticated users can upload course files"
    ON storage.objects FOR INSERT
    TO authenticated
    WITH CHECK ( bucket_id = 'courses' );

    -- 3. Policy to allow authenticated users to UPDATE files (e.g., move/rename).
    CREATE POLICY "Authenticated users can update course files"
    ON storage.objects FOR UPDATE
    TO authenticated
    USING ( bucket_id = 'courses' );

    -- 4. Policy to allow authenticated users to DELETE files.
    CREATE POLICY "Authenticated users can delete course files"
    ON storage.objects FOR DELETE
    TO authenticated
    USING ( bucket_id = 'courses' );
    ```
    *   Click **"Run"**. You must see a "Success. No rows returned" message. Once this is done, your file uploads will work.

### Step 3: Connect Frontend to Supabase

Your Supabase credentials are required to connect the application to the database. They are located in the `src/services/supabaseClient.ts` file.

1.  Open the file `src/services/supabaseClient.ts`.
2.  You will find your credentials already set up for you. If you ever need to change them, this is the file to edit.

    ```typescript
    // src/services/supabaseClient.ts

    const supabaseUrl = "https://qzlxlxowkwtxpdxfdrql.supabase.co";
    const supabaseAnonKey = "eyJhbGciOi...JbJ2Tk"; // Your key
    ```

> **Security Warning:** Hardcoding keys in your frontend code is convenient for initial setup but is not recommended for production. Anyone who can view your website's source code can see these keys. For deployment, you should switch to using **Environment Variables** as described by your hosting provider (e.g., Vercel, Netlify). This involves removing the hardcoded keys and loading them from a secure store, for example: `const supabaseUrl = process.env.VITE_SUPABASE_URL;`

### Troubleshooting Common Errors
> **ATTENTION: READ THIS IF YOU SEE AN ERROR**
> 
> **Common Error Message:**
> > `Could not find the 'file_url' column of 'courses' in the schema cache`
> 
> This is one of the most common setup errors. It means your application is trying to access a column that doesn't exist in your database, or that your browser has an outdated "memory" of your database structure.
> 
> **Solution Steps:**
> 
> 1.  **Surgical Fix (Recommended First Step):** If you have already set up your tables and data but are specifically missing the `file_url` column, you can add it without re-running the entire setup. Go to the **SQL Editor** in Supabase and run this single command:
>     ```sql
>     -- Adds only the missing 'file_url' column to your existing 'courses' table.
>     ALTER TABLE public.courses
>     ADD COLUMN IF NOT EXISTS file_url TEXT;
>     ```
>     This is the safest way to fix the issue without affecting your existing data.
> 
> 2.  **Full Script (If Step 1 doesn't work or other tables are missing):** Ensure you have successfully run the full database setup script from **Step 2** in your Supabase SQL Editor. This script creates all necessary tables, including the `courses` table and the essential `file_url` column. The script is designed to be safe to run multiple times.
> 
> 3.  **Hard Refresh (After running a SQL command):** After running either of the SQL commands above, you **must** perform a **hard refresh** of the application in your browser.
>     -   Windows/Linux: `Ctrl+Shift+R`
>     -   Mac: `Cmd+Shift+R`
> 
>     A hard refresh forces the browser to clear its local cache and fetch the latest database schema from Supabase, which will resolve the error. If you encounter errors about other missing tables (like `unavailabilities` or `appointments`), the solution is the same: run the full script and then hard refresh.

---

## 2. Email Notifications with Resend

Resend is a modern email API for developers. We'll use it to send booking confirmations and contact form notifications.

1.  **Create an Account:** Go to [resend.com](https://resend.com) and sign up for a free account.
2.  **Add and Verify Your Domain:** To send emails that don't land in spam, you must send from a domain you own. Follow their guide to add your domain and verify the DNS records. **This is a critical step for production.** You can skip this for initial testing.
3.  **Get API Key:** Go to the **API Keys** section and create a new key with full access. Copy it and keep it safe; you'll need it in the next step.

---

## 3. Backend Logic with Supabase Edge Functions

We'll deploy a serverless function to handle the logic of sending emails for both new appointments and new contact messages.

### Step 1: Using the Supabase CLI

You can run the Supabase CLI without a global installation by prefixing every command with `npx`. This guide will assume you are using `npx`.

### Step 2: Initialize Supabase Project in Your Terminal

If you haven't already, log in and link your project:
```bash
npx supabase login
npx supabase link --project-ref YOUR_PROJECT_ID
```
(Find `YOUR_PROJECT_ID` in your Supabase project's URL: `https://app.supabase.com/project/YOUR_PROJECT_ID`).

### Step 3: Create and Deploy the Notification Function

1.  **Create the Edge Function:**
    The code for the function is already written for you in `supabase/functions/send-notifications/index.ts`. If that directory doesn't exist, this command will create it.
    ```bash
    npx supabase functions new send-notifications
    ```
    This creates a folder at `supabase/functions/send-notifications`. The `index.ts` file inside contains the logic to send emails for both new appointments and new contact form submissions.

2.  **Set Secrets:**
    Your function needs your Resend API Key and the email address where you want to receive admin notifications. Set them securely using these commands:
    ```bash
    npx supabase secrets set RESEND_API_KEY="re_YourResendApiKeyFromStep2"
    npx supabase secrets set ADMIN_EMAIL="your.admin_email@example.com"
    ```

3.  **Deploy the Function:**
    ```bash
    npx supabase functions deploy send-notifications --no-verify-jwt
    ```
    The `--no-verify-jwt` flag is important because this function will be called by a database webhook, not an authenticated user.

---

## 4. Automating Emails with Database Webhooks

This step connects your database to your function, automatically triggering it when new data is added. You will create **two separate webhooks** that both point to the **same function**.

### Webhook for New Appointments

1.  In your Supabase dashboard, go to **Database > Webhooks**.
2.  Click **Create a new webhook**.
3.  **Name:** `Send Appointment Emails`
4.  **Table:** Choose the `appointments` table.
5.  **Events:** Check only the **`INSERT`** box.
6.  **Webhook URL:** Go to **Edge Functions** in the Supabase dashboard, select your `send-notifications` function, and copy its URL. Paste that URL here.
7.  Click **Create webhook**.

### Webhook for New Contact Messages

1.  Click **Create a new webhook** again.
2.  **Name:** `Send Contact Form Notification`
3.  **Table:** Choose the `contacts` table.
4.  **Events:** Check only the **`INSERT`** box.
5.  **Webhook URL:** Paste the **exact same** function URL you used for appointments.
6.  Click **Create webhook**.

### Testing Your Webhooks
After deploying your function and setting up the webhooks, you can test them by submitting the booking or contact forms on your live website.

> **Resend "From" Address for Testing**
> The provided `send-notifications` function uses `onboarding@resend.dev` as the sender. This is a special address provided by Resend for testing purposes and does not require domain verification. You can use this for free while you develop your application.
> 
> **For Production:** When you are ready to go live, you **must**:
> 1.  Verify your own domain in Resend (e.g., `your-domain.com`).
> 2.  Update the `RESEND_FROM_EMAIL` constant in your `supabase/functions/send-notifications/index.ts` file to use an email from your verified domain (e.g., `'Alice <hello@your-domain.com>'`).
> 3.  Redeploy the function using the `npx supabase functions deploy...` command.

Now, your email notification system is fully automated!

---

## 5. Owner Dashboard & Management

The application includes a complete admin dashboard for managing the platform.

### Step 1: Create an Admin User

1.  Go to **Authentication > Providers** in your Supabase dashboard and ensure the **Email** provider is enabled.
2.  Navigate to **Authentication > Users**.
3.  Click **Add user** and create a user with an email and a strong password. This will be your admin account.

### Step 2: Access the Admin Dashboard

1.  In the running application, navigate to the `/#/login` route in your browser.
2.  Use the credentials you created in the previous step to log in.
3.  Upon successful login, you will be redirected to the admin dashboard at `/#/admin`.

### Step 3: Manage Course Files

The "Course Management" tab on the dashboard lists all courses from your database.
- If a course is missing its video/audio file, you can use the **Upload File** button.
- This uploads the file to your Supabase `courses` storage bucket and automatically links the public URL to the course in your database.
- The feature is implemented in `src/components/CourseManagement.tsx`.

### Step 4: Manage Availability

The "Availability" tab allows you to block out times when you are not available for appointments.
- Use the calendar to select a date.
- You can choose to block the entire day or specify a start and end time.
- These unavailabilities are saved to the `unavailabilities` table.
- The public-facing booking calendar in `src/components/Booking.tsx` automatically fetches this data and disables the corresponding time slots, preventing clients from booking them.
- The admin interface for this is located in `src/components/AvailabilityManagement.tsx`.


---

## 6. Payment Integration with Paddle

Paddle provides a complete payments infrastructure.

### Step 1: Setup Paddle

1.  Create an account on [Paddle](https://paddle.com).
2.  Go to **Catalog > Products** and create products for each course. Note the **Product ID** for each. You will store this ID in the `paddle_product_id` column of your `courses` table.
3.  Go to **Developer Tools > Authentication** to get your **Client-side Token**.

### Step 2: Integrate Paddle.js

In `CourseCard.tsx`, update the `handleBuyNow` function to trigger the Paddle checkout. This requires adding Paddle's JS library and initializing it.

---

## 7. Deployment

Deploying your frontend is straightforward with a service like Vercel or Netlify.

1.  Push your project to a Git provider (GitHub, GitLab).
2.  Import the project into Vercel/Netlify.
3.  **Configure Environment Variables:** In the deployment platform's settings, you **must** add your Supabase credentials so the frontend can connect to it. These are the same variables from your `.env` file.
    *   `VITE_SUPABASE_URL`: Your Supabase Project URL.
    *   `VITE_SUPABASE_ANON_KEY`: Your Supabase `anon` public key.
4.  Deploy. Your site will be live in minutes!